<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
    </style>
    <script>
    const positive = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
    const negative = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z'];

    function decompress(compressed, rowLength) {
        const parts = compressed.split('.');
        let output = [];
        let result = parts[1];
        // First character is the decimal precision
        let decimals = parseInt(parts[0].substring(0, 1));
        // Second character is the accuracy, e.g. 5 would round to nearest 5
        let accuracy = parseInt(parts[0].substring(1, 2));
        // Value of the first reading
        let start = parseInt(parts[0].substring(2, parts[0].length));
        start = start / Math.pow(10.0, decimals);
        // Push the first reading into the result array
        output.push(start);

        // bbbb is compressed to 4b, the numeric value 4 is stored in the multiplier variable
        let multiplier = '';
        let counter = 1;

        // Use Aa-Zz values to calculate the diff from the previous value
        for (let n = 0; n < result.length; n += 1) {
            let found = false;
            let indexOfItem = positive.indexOf(result[n]);

            if (indexOfItem === -1) {
                indexOfItem = negative.indexOf(result[n]);
                if (indexOfItem >= 0) {
                    found = true;
                    indexOfItem = -indexOfItem;
                }
            } else {
                found = true;
            }
            // If not Aa-Zz it will be a numeric multiplier
            if (!found) {
                multiplier += result[n];
            } else {
                // Found a Aa-Zz match! Calculate the numeric value.
                if (Math.abs(indexOfItem) > 0) {
                    indexOfItem = indexOfItem * accuracy;
                }
                indexOfItem = indexOfItem / Math.pow(10, decimals);

                multiplier = parseInt(multiplier);
                
                if (counter > 1 && counter % rowLength === 0) {
                    start = output[counter - rowLength];
                }
                counter += 1;
                // console.log(result[n], indexOfItem);
                start += indexOfItem;
                output.push(parseFloat(parseFloat(start).toFixed(decimals)));            

                // Turn 4b into bbbb
                while (multiplier > 1) {
                    
                    if (counter > 1 && counter % rowLength === 0) {
                        start = output[counter - rowLength];
                    }
                    counter += 1;
                    start += indexOfItem;
                    output.push(parseFloat(parseFloat(start).toFixed(decimals)));
                    multiplier -= 1;
                }
                multiplier = '';

            }

        }
        return output;
    }
    function heatMapColorforValue(value){
        let h;
        let l = 50;
        let s;
        let a = 1;
        if (value < 35) {
            h = 190 + (1.0 - (value/35)) * 40;
            l = 50 + value / 1.1;
            s = 50 + value;
            a = 0.75;
        } else {
            h = 0 + (1.0 - ((value - 35)/65)) * 40;
            l = 20 + (100 - value);
            s = 100;
        }
        return `hsla( ${h}, ${s}%, ${l}%, ${a})`;
    }

    function percentToRGB(percent) {
        if (percent === 100) {
            percent = 99
        }
        var r, g, b;
        var result = '';
        if (percent < 50) {
            // blue to yellow
            r = Math.floor(255 * ((percent - 30) / 20));//Math.floor(255 * ((50 - percent % 50) / 100));
            g = Math.floor(180 * ((percent) / 50));//Math.floor(80 * ((65 - percent) / 50));;//Math.floor(200 * (percent / 50) - 50);//Math.floor(255 * (percent / 100));//Math.floor(255 * (percent / 50));;
            b = Math.floor(255 * ((75 - percent) / 50));
            result = 'rgba(' + r + ',' + g + ',' + b + ', 0.9)';
        } else {
            // yellow to red
            r = 255;
            g = Math.floor(200 * ((50 - percent % 50) / 50));
            b = Math.floor(100 * ((50 - percent % 50) / 50));//0;
            result = 'rgba(' + r + ',' + g + ',' + b + ', 0.9)';
        }
        return result;
    }

    function interpolateData(input, rowLength) {
        const output = [];
        let rowNum = 1;
        for (let n = 0; n < input.length; n += 1) {
            output.push(input[n]);
            if ( (n + 1) % rowLength === 0) {
                if (input.length - n > rowLength) {
                    for(let r = 1; r <= rowLength * 2 - 1; r ++) {
                        const roundedA = ((rowNum - 1) * rowLength) + Math.floor((r - 1) / 2);
                        const roundedB = ((rowNum - 1) * rowLength) + Math.floor((r - 1) / 2);
                        const topA = input[roundedA];
                        const topB = input[roundedB];
                        const roundedC = (rowNum * rowLength) + Math.floor((r - 1) / 2);
                        const roundedD = (rowNum * rowLength) + Math.floor((r - 1) / 2);
                        const bottomA = input[roundedC];
                        const bottomB = input[roundedD];
                        output.push((topA + topB + bottomA + bottomB) / 4);
                    }
                    rowNum += 1;
                }
                // Do nothing
            } else {
                output.push((input[n] + input[n + 1]) / 2)
            }
        }
        return output;
    }

    let connection = new WebSocket('ws://192.168.1.146:81');
    connection.onopen = function () {
        connection.send('Ping'); // Send the message 'Ping' to the server
    };
    // Log errors
    connection.onerror = function (error) {
        console.log('WebSocket Error ' + error);
    };
    let highTarget = -100;
    let lowTarget = 200;
    let high = -100;
    let low = 200;
    let counter = 20;
    // Log messages from the server
    connection.onmessage = function (e) {
        if (e.data.length < 100) {
            return;
        }
        // console.log(e.data);
        const values = decompress(e.data, 32);
        const tempValues = interpolateData(values, 32);
        if (counter >= 10) {
            highTarget = -100;
            lowTarget = 200;
            //console.log(JSON.stringify(tempValues));
            for(let i = 0; i < tempValues.length; i += 1) {
                if (tempValues[i] < 120 && tempValues[i] > highTarget) {
                    highTarget = parseInt(tempValues[i]);
                }
                if (tempValues[i] < lowTarget) {
                    lowTarget = parseInt(tempValues[i]);
                }
            }
            if (highTarget - lowTarget < 10) {
                highTarget += 5;
            }
            // high += 2;
            lowTarget += 1;
            counter = 0;

        }
        counter += 1;
        if(low === 200) {
            low = lowTarget;
        } else if (low > lowTarget) {
            low -= 1;
        } else if (low < lowTarget) {
            low += 1;
        }
        if(high === -100) {
            high = highTarget;
        } else if (high > highTarget) {
            high -= 1;
        } else if (high < highTarget) {
            high += 1;
        }

        var c2 = document.getElementById('myCanvas');
        var c2_context = c2.getContext('2d');
        let xPos = 460;
        let yPos = 0;
        for(let i = 0; i < tempValues.length; i += 1) {
            let value = ((tempValues[i] - low) / (high - low)) * 100;
            c2_context.fillStyle = heatMapColorforValue(value);
            c2_context.fillRect(xPos, yPos, 10, 12);
            yPos += 12;
            if (i > 0 && (i + 1) % 63 === 0) {
                xPos -= 10;
                yPos = 0;
            }
        } 
    };
    </script>
</head>
<body>
    <canvas id='myCanvas' width='470' height='756' style='border:1px solid #d3d3d3;'></canvas>
</body>
</html>